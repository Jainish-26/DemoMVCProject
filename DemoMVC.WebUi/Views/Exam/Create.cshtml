@model DemoMVC.WebUi.Models.ExamModel
@using Kendo.Mvc.UI
@using DemoMVC.WebUi.Helper
@using DemoMVC.WebUi.Controllers
@using DemoMVC.Models

@{
    ViewBag.Title = Model.ExamId > 0 ? "Edit Exam" : "Create Exam";
    string formCode = AuthorizeFormAccess.FormAccessCode.EXAM.ToString();
    string role = SessionHelper.RoleName;
    var formName = FormUtility.GetFormName(formCode);
    string parentFormname = FormUtility.GetParentFormName(formCode);
    ViewBag.Title = formName;
    BaseController _base = new BaseController();
    bool AllowedEdit = _base.CheckPermission(formCode, AccessPermission.IsEdit);
    bool AllowedAdd = _base.CheckPermission(formCode, AccessPermission.IsAdd);
    bool AllowedDelete = _base.CheckPermission(formCode, AccessPermission.IsDelete);

    
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewBag.Title</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        body {
            background-color: #f4f7f6;
        }

        .form-container {
            width: 100%;
            margin: 20px auto;
            padding: 20px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .form-label {
            font-weight: bold;
        }

        .required-icon {
            color: red;
            margin-left: 5px;
        }

        .btn-custom {
            background: #17a2b8;
            color: white;
            border-radius: 5px;
            padding: 10px;
            transition: 0.3s;
        }

            .btn-custom:hover {
                background: #138496;
            }

        .toggle-input {
            display: none;
        }

        .toggle-label {
            font-weight: bold;
            padding: 10px;
            cursor: pointer;
        }

        .toggle-switch {
            width: 40px;
            height: 20px;
            border-radius: 10px;
            background: #ccc;
            position: relative;
            cursor: pointer;
        }

            .toggle-switch::before {
                content: '';
                position: absolute;
                width: 18px;
                height: 18px;
                background: white;
                border-radius: 50%;
                top: 50%;
                left: 2px;
                transform: translateY(-50%);
                transition: 0.3s;
            }

        .toggle-input:checked + .toggle-switch {
            background: #28a745;
        }

            .toggle-input:checked + .toggle-switch::before {
                left: 20px;
            }

        /* Ensure items stay in a row */
        .row {
            flex-wrap: nowrap;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h2 class="text" style="margin-left :30px"> @ViewBag.Title</h2>
    <div class="">
        <div class="form-container">
            @Html.Hidden("hdnFormAccessCode", formCode)
            <form id="form" enctype="multipart/form-data">
                @Html.HiddenFor(model => model.ExamId)
                @Html.AntiForgeryToken()

                <div class="d-flex flex-nowrap align-items-end gap-2">
                    <!-- Exam Name -->
                    <div class="col-auto">
                        <label class="form-label">Exam Name <span class="required-icon">*</span></label>
                        @Html.TextBoxFor(model => model.ExamName, new { @class = "form-control", placeholder = "Enter Exam Name" })
                        @Html.ValidationMessageFor(model => model.ExamName, "", new { @class = "text-danger" })
                    </div>

                    <!-- Exam Code -->
                    <div class="col-auto">
                        <label class="form-label">Exam Code <span class="required-icon">*</span></label>
                        @if (Model.ExamId > 0)
                        {
                            @Html.TextBoxFor(model => model.ExamCode, new { @class = "form-control", @readonly = "readonly" })
                        }
                        else
                        {
                            @Html.TextBoxFor(model => model.ExamCode, new { @class = "form-control text-uppercase", placeholder = "Enter Exam Code" })
                        }
                        @Html.ValidationMessageFor(model => model.ExamCode, "", new { @class = "text-danger" })
                    </div>

                    <!-- Exam Marks -->
                    <div class="col-auto">
                        <label class="form-label">Marks <span class="required-icon">*</span></label>
                        @Html.TextBoxFor(model => model.TotalMarks, new { @class = "form-control", placeholder = "Total Marks" })
                        @Html.ValidationMessageFor(model => model.TotalMarks, "", new { @class = "text-danger" })
                    </div>

                    <!-- Passing Marks -->
                    <div class="col-auto">
                        <label class="form-label">Passing Marks <span class="required-icon">*</span></label>
                        @Html.TextBoxFor(model => model.PassingMarks, new { @class = "form-control", placeholder = "Passing Marks" })
                        @Html.ValidationMessageFor(model => model.PassingMarks, "", new { @class = "text-danger" })
                    </div>

                    <!-- Duration -->
                    <div class="col-auto">
                        <label class="form-label">Duration (mins) <span class="required-icon">*</span></label>
                        @Html.TextBoxFor(model => model.DurationMin, new { @class = "form-control", placeholder = "Exam Duration" })
                        @Html.ValidationMessageFor(model => model.DurationMin, "", new { @class = "text-danger" })
                    </div>

                    <!-- Is Active Toggle -->
                    <div class="col-auto d-flex flex-column align-items-center">
                        <label class="form-label">Active?</label>
                        <div class="d-flex align-items-center">
                            <input type="checkbox" id="IsActiveToggle" class="toggle-input" @if (Model.IsActive) { <text> checked</text> }>
                            <label for="IsActiveToggle" class="toggle-switch"></label>
                        </div>
                        @Html.HiddenFor(model => model.IsActive, new { @id = "IsActive" })
                    </div>

                    <!-- Buttons -->
                    <div class="col-auto d-flex align-items-center">
                        <button type="button" onclick="saveExamAndQuestions()" class="btn btn-warning rounded-pill px-4 shadow-sm fw-bold">
                            <i class="fa fa-save"></i> Save
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-outline-success rounded-pill px-4 shadow-sm ms-2">
                            <i class="fa fa-arrow-left"></i> Back
                        </a>
                    </div>
                </div>
            </form>
        </div>
        <div class="common_white_box listingpage m-4">
            <div class="page-loader k-loading-image"></div>
            @(Html.Kendo().Grid<DemoMVC.Models.QuestionGridModel>()
            .Name("gridExamQuestion")
            .AutoBind(true)
            //.Excel(excel => excel
            //  .FileName("FormList.xlsx")
            //  .Filterable(true)
            //  .AllPages(true))
            .Columns(columns =>
            {

                columns.Bound(c => c.QuestionId).Width("7%")
                .ClientTemplate("<input type='checkbox' class='toggle-edit' data-id='#= QuestionId #' />")
                .Title("Enable Edit");
                columns.Bound(c => c.Subject).Width("7%").Title("Subject");
                columns.Bound(c => c.Type).Width("7%").Title("Answer Type");
                columns.Bound(c => c.QuestionText).Width("7%").Title("Question")
                .ClientTemplate("<span>#:QuestionText.substring(0, 80) #</span>");
                columns.Bound(c => c.Marks).Width("7%").Title("Marks");
                columns.Bound(c => c.QuestionId).HeaderHtmlAttributes(new { @class = "center_text" }).HtmlAttributes(new { @class = "kendogrid_Action center_text" }).ClientTemplate("<div class='k_action_table'>" + (AllowedEdit ? "<a href='javascript:void()' onclick=\"fnShowDetails(#= QuestionId #,'Access')\"><i class='fa fa-eye'></i></a>" : "")).Filterable(false).Title("Action").Width("7%").Sortable(false);
            })
            .Editable(editable => editable.Mode(GridEditMode.InCell))
            .NoRecords("No record found")
            .Events(evt => evt
               .DataBinding("fnKendoGridCommonDataBinding")
               .DataBound("fnKendoGridDataBoundEvent")
            )
            .Sortable()
            //.Filterable(filter => filter
            //    .Mode(GridFilterMode.Row)
            //    .Extra(false)
            //    .Operators(o => o.ForString(f => f.Clear().Contains("Contains").DoesNotContain("Does Not Contain").StartsWith("Starts With").EndsWith("Ends With").IsEqualTo("Equal To").IsNotEqualTo("Not Equal To")))
            //    .Operators(o => o.ForNumber(g => g.Clear().IsEqualTo("EqualTo").IsNotEqualTo("Not Equal To").IsGreaterThan("Greater Than").IsGreaterThanOrEqualTo("Greater Than Or Equal To").IsLessThan("Less Than").IsLessThanOrEqualTo("Less Than Or Equal To")))
            //)
            .Pageable(pageable => pageable
                .Refresh(true)
                .PageSizes(new[] {10,20, 50, 100, 200 })
                .ButtonCount(5)
            )
             .DataSource(dataSource => dataSource
                 .Ajax()
                 .Model(
                 model =>
                 {
                     model.Id(m => m.QuestionId);
                     model.Field(m => m.QuestionId).Editable(false);
                     model.Field(m => m.Marks).Editable(true);
                     model.Field(m => m.QuestionImage).Editable(false);
                     model.Field(m => m.QuestionText).Editable(false);
                     model.Field(m => m.Subject).Editable(false);
                     model.Field(m => m.Type).Editable(false);
                 })
                 //.Sort(sortable=>sortable.Add("Name").Ascending())
                 .Read(read => read.Action("GetGridExamQuestionData", "Exam").Data("sendExamId")).PageSize(10)
             )
        )
        </div>
        <div class="common_white_box listingpage m-4">
            <div class="page-loader k-loading-image"></div>
            @(Html.Kendo().Grid<DemoMVC.Models.QuestionGridModel>()
            .Name("gridUnassignedQuestion")
            .AutoBind(true)
            //.Excel(excel => excel
            //  .FileName("FormList.xlsx")
            //  .Filterable(true)
            //  .AllPages(true))
            .Columns(columns =>
            {

                columns.Bound(c => c.QuestionId).Width("7%")
                .ClientTemplate("<input type='checkbox' class='toggle-edit' data-id='#= QuestionId #' />")
                .Title("Enable Edit");
                columns.Bound(c => c.Subject).Width("7%").Title("Subject");
                columns.Bound(c => c.Type).Width("7%").Title("Answer Type");
                columns.Bound(c => c.QuestionText).Width("7%").Title("Question")
                .ClientTemplate("<span>#:QuestionText.substring(0, 80) #</span>");
                columns.Bound(c => c.Marks).Width("7%").Title("Marks");
                columns.Bound(c => c.QuestionId).HeaderHtmlAttributes(new { @class = "center_text" }).HtmlAttributes(new { @class = "kendogrid_Action center_text" }).ClientTemplate("<div class='k_action_table'>" + (AllowedEdit ? "<a href='javascript:void()' onclick=\"fnShowDetails(#= QuestionId #,'Access')\"><i class='fa fa-eye'></i></a>" : "")).Filterable(false).Title("Action").Width("7%").Sortable(false);
            })
            .Editable(editable => editable.Mode(GridEditMode.InCell))
            .NoRecords("No record found")
            .Events(evt => evt
                .DataBinding("fnKendoGridCommonDataBinding")
                .DataBound("fnKendoGridDataBoundEvent")
            )
            .Sortable()
            //.Filterable(filter => filter
            //    .Mode(GridFilterMode.Row)
            //    .Extra(false)
            //    .Operators(o => o.ForString(f => f.Clear().Contains("Contains").DoesNotContain("Does Not Contain").StartsWith("Starts With").EndsWith("Ends With").IsEqualTo("Equal To").IsNotEqualTo("Not Equal To")))
            //    .Operators(o => o.ForNumber(g => g.Clear().IsEqualTo("EqualTo").IsNotEqualTo("Not Equal To").IsGreaterThan("Greater Than").IsGreaterThanOrEqualTo("Greater Than Or Equal To").IsLessThan("Less Than").IsLessThanOrEqualTo("Less Than Or Equal To")))
            //)
            .Pageable(pageable => pageable
                .Refresh(true)
                .PageSizes(new[] {10,20, 50, 100, 200 })
                .ButtonCount(5)
            )
                .DataSource(dataSource => dataSource
                    .Ajax()
                    .Model(
                    model =>
                    {
                        model.Id(m => m.QuestionId);
                        model.Field(m => m.QuestionId).Editable(false);
                        model.Field(m => m.Marks).Editable(true);
                        model.Field(m => m.QuestionImage).Editable(false);
                        model.Field(m => m.QuestionText).Editable(false);
                        model.Field(m => m.Subject).Editable(false);
                        model.Field(m => m.Type).Editable(false);
                    })
                    //.Sort(sortable=>sortable.Add("Name").Ascending())
                    .Read(read => read.Action("GetGridUnassignedQuestionData", "Exam").Data("sendExamId")).PageSize(10)
                )
        )
        </div>
    </div>
    <div id="questionModelContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    @*Set ViewBagId For GridData*@
    <script>
    function sendExamId() {
        return {
            examId: '@ViewBag.ExamId'
        };
        }
    </script>
    @*//show Details PopUp*@
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var toggleInput = document.getElementById("IsActiveToggle");
            var hiddenInput = document.getElementById("IsActive");

            function updateLabel() {
                hiddenInput.value = toggleInput.checked ? "True" : "False";
            }

            toggleInput.addEventListener("change", updateLabel);
            updateLabel(); // Set initial state
        });
         function fnShowDetails(QuestionId,access) {
             $.ajax({
                 url: '@Url.Action("GetQuestionDetails","Question")',
                 type: 'GET',
                 data: { id: QuestionId, access },
                 success: function (response) {
                     $("#questionModelContainer").html(response);
                     $("#questionDetailsModal").modal("show");
                 },
                 error: function () {
                     alert(" Failed To Load Data");
                 }
             });
         }
    </script>
    @*Send Exam And Questions In Controller By AJAX*@
    <script>
        function saveExamAndQuestions() {
            // Collect form data
            var formData = $("#form").serializeArray();
            var formObject = {};

            $.each(formData, function (index, field) {
                formObject[field.name] = field.value;
            });

            // Collect selected grid questions
            var grid = $("#gridUnassignedQuestion").data("kendoGrid");
            var selectedQuestions = [];

            grid.tbody.find("tr").each(function () {
                var row = $(this);
                var checkbox = row.find(".toggle-edit");
                if (checkbox.is(":checked")) {
                    var dataItem = grid.dataItem(row);
                    selectedQuestions.push({
                        QuestionId: dataItem.QuestionId,
                        Marks: dataItem.Marks
                    });
                }
            });

            // Combine form data and selected questions
            var requestData = {
                Exam: formObject,
                SelectedQuestions: selectedQuestions
            };

            if (selectedQuestions.length === 0) {
                Swal.fire("No Questions Selected!", "Please select questions to save.", "warning");
                return;
            }
            console.log(requestData);
            //Send AJAX request
            $.ajax({
                url: "/Exam/Create",
                type: "POST",
                data: JSON.stringify(requestData),
                contentType: "application/json",
                success: function (response) {
                    if (response.success) {
                        Swal.fire("Success!", response.message, "success");
                        window.location.href = "/Exam/Index";
                    } else {
                        Swal.fire("Error!", response.message, "error");
                    }
                },
                error: function () {
                    Swal.fire("Error!", "An error occurred while saving the exam and questions.", "error");
                }
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>
